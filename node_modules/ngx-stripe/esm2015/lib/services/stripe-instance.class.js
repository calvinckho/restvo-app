/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject, from } from 'rxjs';
import { filter, first, map, switchMap } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { isAccount, isAccountData, isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { isHandleCardPaymentOptions } from '../interfaces/payment-intent';
export class StripeInstance {
    /**
     * @param {?} loader
     * @param {?} window
     * @param {?} key
     * @param {?=} options
     */
    constructor(loader, window, key, options) {
        this.loader = loader;
        this.window = window;
        this.key = key;
        this.options = options;
        this.stripe$ = new BehaviorSubject(undefined);
        this.loader
            .asStream()
            .pipe(filter((status) => status.loaded === true), first(), map(() => ((/** @type {?} */ (this.window.getNativeWindow()))).Stripe))
            .subscribe((Stripe) => {
            /** @type {?} */
            const stripe = this.options
                ? ((/** @type {?} */ (Stripe(this.key, this.options))))
                : ((/** @type {?} */ (Stripe(this.key))));
            this.stripe$.next(stripe);
        });
    }
    /**
     * @return {?}
     */
    getInstance() {
        return this.stripe$.getValue();
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    elements(options) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), map(stripe => ((/** @type {?} */ (stripe))).elements(options)), first());
    }
    /**
     * @param {?} a
     * @param {?} b
     * @return {?}
     */
    createToken(a, b) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            if (isAccount(a) && isAccountData(b)) {
                return from(stripe.createToken(a, b));
            }
            else if (isBankAccount(a) && isBankAccountData(b)) {
                return from(stripe.createToken(a, b));
            }
            else if (isPii(a) && isPiiData(b)) {
                return from(stripe.createToken(a, b));
            }
            else {
                return from(stripe.createToken((/** @type {?} */ (a)), (/** @type {?} */ (b))));
            }
        }), first());
    }
    /**
     * @param {?} a
     * @param {?=} b
     * @return {?}
     */
    createSource(a, b) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            if (isSourceData(a)) {
                return from(stripe.createSource((/** @type {?} */ (a))));
            }
            return from(stripe.createSource((/** @type {?} */ (a)), b));
        }), first());
    }
    /**
     * @param {?} source
     * @return {?}
     */
    retrieveSource(source) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            return from(stripe.retrieveSource(source));
        }), first());
    }
    /**
     * @param {?} options
     * @return {?}
     */
    paymentRequest(options) {
        /** @type {?} */
        const stripe = this.getInstance();
        if (stripe) {
            return stripe.paymentRequest(options);
        }
        return undefined;
    }
    /**
     * @param {?} a
     * @param {?} b
     * @param {?=} c
     * @return {?}
     */
    handleCardPayment(a, b, c) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            if (isHandleCardPaymentOptions(b)) {
                return from(stripe.handleCardPayment((/** @type {?} */ (a)), (/** @type {?} */ (b))));
            }
            return from(stripe.handleCardPayment((/** @type {?} */ (a)), (/** @type {?} */ (b)), (/** @type {?} */ (c))));
        }));
    }
    /**
     * @param {?} a
     * @return {?}
     */
    handleCardAction(a) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            return from(stripe.handleCardAction((/** @type {?} */ (a))));
        }));
    }
    /**
     * @param {?} a
     * @param {?=} b
     * @return {?}
     */
    confirmPaymentIntent(a, b) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            return from(stripe.confirmPaymentIntent((/** @type {?} */ (a)), (/** @type {?} */ (b))));
        }));
    }
    /**
     * @param {?} a
     * @param {?} b
     * @param {?=} c
     * @return {?}
     */
    createPaymentMethod(a, b, c) {
        return this.stripe$.asObservable().pipe(filter(stripe => Boolean(stripe)), switchMap(s => {
            /** @type {?} */
            const stripe = (/** @type {?} */ (s));
            return from(stripe.createPaymentMethod(a, b, c));
        }), first());
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    StripeInstance.prototype.stripe$;
    /** @type {?} */
    StripeInstance.prototype.loader;
    /** @type {?} */
    StripeInstance.prototype.window;
    /** @type {?} */
    StripeInstance.prototype.key;
    /** @type {?} */
    StripeInstance.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLWluc3RhbmNlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zdHJpcGUtaW5zdGFuY2UuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVEvRCxPQUFPLEVBR0wsWUFBWSxFQUViLE1BQU0sdUJBQXVCLENBQUM7QUFDL0IsT0FBTyxFQVNMLFNBQVMsRUFDVCxhQUFhLEVBQ2IsYUFBYSxFQUNiLGlCQUFpQixFQUNqQixLQUFLLEVBQ0wsU0FBUyxFQUNWLE1BQU0scUJBQXFCLENBQUM7QUFHN0IsT0FBTyxFQU1MLDBCQUEwQixFQUMzQixNQUFNLDhCQUE4QixDQUFDO0FBRXRDLE1BQU0sT0FBTyxjQUFjOzs7Ozs7O0lBS3pCLFlBQ1MsTUFBMkIsRUFDM0IsTUFBaUIsRUFDakIsR0FBVyxFQUNYLE9BQWlCO1FBSGpCLFdBQU0sR0FBTixNQUFNLENBQXFCO1FBQzNCLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDakIsUUFBRyxHQUFILEdBQUcsQ0FBUTtRQUNYLFlBQU8sR0FBUCxPQUFPLENBQVU7UUFSbEIsWUFBTyxHQUEwQyxJQUFJLGVBQWUsQ0FFMUUsU0FBUyxDQUFDLENBQUM7UUFRWCxJQUFJLENBQUMsTUFBTTthQUNSLFFBQVEsRUFBRTthQUNWLElBQUksQ0FDSCxNQUFNLENBQUMsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLEVBQ2xELEtBQUssRUFBRSxFQUNQLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLG1CQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEVB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Q0FDeEIsQ0FBUyxFQUNULENBQVUsRUFDVixDQUFpQztRQUVqQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDakMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFOztrQkFDTixNQUFNLEdBQUcsbUJBQUEsQ0FBQyxFQUFZO1lBRTVCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLEVBQ0YsS0FBSyxFQUFFLENBQ1IsQ0FBQztJQUNKLENBQUM7Q0FDRjs7Ozs7O0lBN0tDLGlDQUVhOztJQUdYLGdDQUFrQzs7SUFDbEMsZ0NBQXdCOztJQUN4Qiw2QkFBa0I7O0lBQ2xCLGlDQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBmaXJzdCwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFdpbmRvd1JlZiB9IGZyb20gJy4vd2luZG93LXJlZi5zZXJ2aWNlJztcbmltcG9ydCB7IExhenlTdHJpcGVBUElMb2FkZXIsIFN0YXR1cyB9IGZyb20gJy4vYXBpLWxvYWRlci5zZXJ2aWNlJztcblxuaW1wb3J0IHsgU3RyaXBlSlMsIE9wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0cmlwZSc7XG5pbXBvcnQgeyBFbGVtZW50IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50JztcbmltcG9ydCB7IEVsZW1lbnRzLCBFbGVtZW50c09wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2VsZW1lbnRzJztcbmltcG9ydCB7XG4gIFNvdXJjZURhdGEsXG4gIFNvdXJjZVJlc3VsdCxcbiAgaXNTb3VyY2VEYXRhLFxuICBTb3VyY2VQYXJhbXNcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zb3VyY2VzJztcbmltcG9ydCB7XG4gIENhcmREYXRhT3B0aW9ucyxcbiAgVG9rZW5SZXN1bHQsXG4gIEFjY291bnQsXG4gIEFjY291bnREYXRhLFxuICBCYW5rQWNjb3VudCxcbiAgQmFua0FjY291bnREYXRhLFxuICBQaWlEYXRhLFxuICBQaWksXG4gIGlzQWNjb3VudCxcbiAgaXNBY2NvdW50RGF0YSxcbiAgaXNCYW5rQWNjb3VudCxcbiAgaXNCYW5rQWNjb3VudERhdGEsXG4gIGlzUGlpLFxuICBpc1BpaURhdGFcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy90b2tlbic7XG5pbXBvcnQgeyBTdHJpcGVTZXJ2aWNlSW50ZXJmYWNlIH0gZnJvbSAnLi9zdHJpcGUtaW5zdGFuY2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBheW1lbnRSZXF1ZXN0T3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvcGF5bWVudC1yZXF1ZXN0JztcbmltcG9ydCB7XG4gIEhhbmRsZUNhcmRQYXltZW50T3B0aW9ucyxcbiAgUGF5bWVudEludGVudFJlc3VsdCxcbiAgQ29uZmlybVBheW1lbnRJbnRlbnRPcHRpb25zLFxuICBQYXltZW50TWV0aG9kRGF0YSxcbiAgUGF5bWVudE1ldGhvZFJlc3VsdCxcbiAgaXNIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnNcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9wYXltZW50LWludGVudCc7XG5cbmV4cG9ydCBjbGFzcyBTdHJpcGVJbnN0YW5jZSBpbXBsZW1lbnRzIFN0cmlwZVNlcnZpY2VJbnRlcmZhY2Uge1xuICBwcml2YXRlIHN0cmlwZSQ6IEJlaGF2aW9yU3ViamVjdDxTdHJpcGVKUyB8IHVuZGVmaW5lZD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFxuICAgIFN0cmlwZUpTIHwgdW5kZWZpbmVkXG4gID4odW5kZWZpbmVkKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgbG9hZGVyOiBMYXp5U3RyaXBlQVBJTG9hZGVyLFxuICAgIHB1YmxpYyB3aW5kb3c6IFdpbmRvd1JlZixcbiAgICBwdWJsaWMga2V5OiBzdHJpbmcsXG4gICAgcHVibGljIG9wdGlvbnM/OiBPcHRpb25zXG4gICkge1xuICAgIHRoaXMubG9hZGVyXG4gICAgICAuYXNTdHJlYW0oKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoc3RhdHVzOiBTdGF0dXMpID0+IHN0YXR1cy5sb2FkZWQgPT09IHRydWUpLFxuICAgICAgICBmaXJzdCgpLFxuICAgICAgICBtYXAoKCkgPT4gKHRoaXMud2luZG93LmdldE5hdGl2ZVdpbmRvdygpIGFzIGFueSkuU3RyaXBlKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoU3RyaXBlOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gdGhpcy5vcHRpb25zXG4gICAgICAgICAgPyAoU3RyaXBlKHRoaXMua2V5LCB0aGlzLm9wdGlvbnMpIGFzIFN0cmlwZUpTKVxuICAgICAgICAgIDogKFN0cmlwZSh0aGlzLmtleSkgYXMgU3RyaXBlSlMpO1xuXG4gICAgICAgIHRoaXMuc3RyaXBlJC5uZXh0KHN0cmlwZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRJbnN0YW5jZSgpOiBTdHJpcGVKUyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgcHVibGljIGVsZW1lbnRzKG9wdGlvbnM/OiBFbGVtZW50c09wdGlvbnMpOiBPYnNlcnZhYmxlPEVsZW1lbnRzPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgbWFwKHN0cmlwZSA9PiAoc3RyaXBlIGFzIFN0cmlwZUpTKS5lbGVtZW50cyhvcHRpb25zKSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUb2tlbihcbiAgICBhOiBFbGVtZW50IHwgQWNjb3VudCB8IEJhbmtBY2NvdW50IHwgUGlpLFxuICAgIGI6IENhcmREYXRhT3B0aW9ucyB8IEFjY291bnREYXRhIHwgQmFua0FjY291bnREYXRhIHwgUGlpRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFRva2VuUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgc3dpdGNoTWFwKHMgPT4ge1xuICAgICAgICBjb25zdCBzdHJpcGUgPSBzIGFzIFN0cmlwZUpTO1xuXG4gICAgICAgIGlmIChpc0FjY291bnQoYSkgJiYgaXNBY2NvdW50RGF0YShiKSkge1xuICAgICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNCYW5rQWNjb3VudChhKSAmJiBpc0JhbmtBY2NvdW50RGF0YShiKSkge1xuICAgICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNQaWkoYSkgJiYgaXNQaWlEYXRhKGIpKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHN0cmlwZS5jcmVhdGVUb2tlbihhIGFzIEVsZW1lbnQsIGIgYXMgQ2FyZERhdGFPcHRpb25zIHwgdW5kZWZpbmVkKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgZmlyc3QoKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlU291cmNlKFxuICAgIGE6IEVsZW1lbnQgfCBTb3VyY2VEYXRhLFxuICAgIGI/OiBTb3VyY2VEYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U291cmNlUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgc3dpdGNoTWFwKHMgPT4ge1xuICAgICAgICBjb25zdCBzdHJpcGUgPSBzIGFzIFN0cmlwZUpTO1xuXG4gICAgICAgIGlmIChpc1NvdXJjZURhdGEoYSkpIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShzdHJpcGUuY3JlYXRlU291cmNlKGEgYXMgU291cmNlRGF0YSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBFbGVtZW50LCBiKSk7XG4gICAgICB9KSxcbiAgICAgIGZpcnN0KClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHJldHJpZXZlU291cmNlKHNvdXJjZTogU291cmNlUGFyYW1zKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLnJldHJpZXZlU291cmNlKHNvdXJjZSkpO1xuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBwYXltZW50UmVxdWVzdChvcHRpb25zOiBQYXltZW50UmVxdWVzdE9wdGlvbnMpIHtcbiAgICBjb25zdCBzdHJpcGUgPSB0aGlzLmdldEluc3RhbmNlKCk7XG4gICAgaWYgKHN0cmlwZSkge1xuICAgICAgcmV0dXJuIHN0cmlwZS5wYXltZW50UmVxdWVzdChvcHRpb25zKTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkUGF5bWVudChcbiAgICBhOiBzdHJpbmcsXG4gICAgYjogRWxlbWVudCB8IEhhbmRsZUNhcmRQYXltZW50T3B0aW9ucyxcbiAgICBjPzogSGFuZGxlQ2FyZFBheW1lbnRPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGZpbHRlcihzdHJpcGUgPT4gQm9vbGVhbihzdHJpcGUpKSxcbiAgICAgIHN3aXRjaE1hcChzID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gcyBhcyBTdHJpcGVKUztcblxuICAgICAgICBpZiAoaXNIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMoYikpIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHN0cmlwZS5oYW5kbGVDYXJkUGF5bWVudChhIGFzIHN0cmluZywgYiBhcyBIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMpXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgIHN0cmlwZS5oYW5kbGVDYXJkUGF5bWVudChcbiAgICAgICAgICAgIGEgYXMgc3RyaW5nLFxuICAgICAgICAgICAgYiBhcyBFbGVtZW50LFxuICAgICAgICAgICAgYyBhcyBIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlQ2FyZEFjdGlvbihhOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmhhbmRsZUNhcmRBY3Rpb24oYSBhcyBzdHJpbmcpKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjb25maXJtUGF5bWVudEludGVudChcbiAgICBhOiBzdHJpbmcsXG4gICAgYj86IENvbmZpcm1QYXltZW50SW50ZW50T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgc3RyaXBlLmNvbmZpcm1QYXltZW50SW50ZW50KFxuICAgICAgICAgICAgYSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBiIGFzIENvbmZpcm1QYXltZW50SW50ZW50T3B0aW9ucyB8IHVuZGVmaW5lZFxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVQYXltZW50TWV0aG9kKFxuICAgIGE6IHN0cmluZyxcbiAgICBiOiBFbGVtZW50LFxuICAgIGM/OiBQYXltZW50TWV0aG9kRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFBheW1lbnRNZXRob2RSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVBheW1lbnRNZXRob2QoYSwgYiwgYykpO1xuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxufVxuIl19