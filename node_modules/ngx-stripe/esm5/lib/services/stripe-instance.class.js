/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject, from } from 'rxjs';
import { filter, first, map, switchMap } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { isAccount, isAccountData, isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { isHandleCardPaymentOptions } from '../interfaces/payment-intent';
var StripeInstance = /** @class */ (function () {
    function StripeInstance(loader, window, key, options) {
        var _this = this;
        this.loader = loader;
        this.window = window;
        this.key = key;
        this.options = options;
        this.stripe$ = new BehaviorSubject(undefined);
        this.loader
            .asStream()
            .pipe(filter(function (status) { return status.loaded === true; }), first(), map(function () { return ((/** @type {?} */ (_this.window.getNativeWindow()))).Stripe; }))
            .subscribe(function (Stripe) {
            /** @type {?} */
            var stripe = _this.options
                ? ((/** @type {?} */ (Stripe(_this.key, _this.options))))
                : ((/** @type {?} */ (Stripe(_this.key))));
            _this.stripe$.next(stripe);
        });
    }
    /**
     * @return {?}
     */
    StripeInstance.prototype.getInstance = /**
     * @return {?}
     */
    function () {
        return this.stripe$.getValue();
    };
    /**
     * @param {?=} options
     * @return {?}
     */
    StripeInstance.prototype.elements = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), map(function (stripe) { return ((/** @type {?} */ (stripe))).elements(options); }), first());
    };
    /**
     * @param {?} a
     * @param {?} b
     * @return {?}
     */
    StripeInstance.prototype.createToken = /**
     * @param {?} a
     * @param {?} b
     * @return {?}
     */
    function (a, b) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            if (isAccount(a) && isAccountData(b)) {
                return from(stripe.createToken(a, b));
            }
            else if (isBankAccount(a) && isBankAccountData(b)) {
                return from(stripe.createToken(a, b));
            }
            else if (isPii(a) && isPiiData(b)) {
                return from(stripe.createToken(a, b));
            }
            else {
                return from(stripe.createToken((/** @type {?} */ (a)), (/** @type {?} */ (b))));
            }
        }), first());
    };
    /**
     * @param {?} a
     * @param {?=} b
     * @return {?}
     */
    StripeInstance.prototype.createSource = /**
     * @param {?} a
     * @param {?=} b
     * @return {?}
     */
    function (a, b) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            if (isSourceData(a)) {
                return from(stripe.createSource((/** @type {?} */ (a))));
            }
            return from(stripe.createSource((/** @type {?} */ (a)), b));
        }), first());
    };
    /**
     * @param {?} source
     * @return {?}
     */
    StripeInstance.prototype.retrieveSource = /**
     * @param {?} source
     * @return {?}
     */
    function (source) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            return from(stripe.retrieveSource(source));
        }), first());
    };
    /**
     * @param {?} options
     * @return {?}
     */
    StripeInstance.prototype.paymentRequest = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var stripe = this.getInstance();
        if (stripe) {
            return stripe.paymentRequest(options);
        }
        return undefined;
    };
    /**
     * @param {?} a
     * @param {?} b
     * @param {?=} c
     * @return {?}
     */
    StripeInstance.prototype.handleCardPayment = /**
     * @param {?} a
     * @param {?} b
     * @param {?=} c
     * @return {?}
     */
    function (a, b, c) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            if (isHandleCardPaymentOptions(b)) {
                return from(stripe.handleCardPayment((/** @type {?} */ (a)), (/** @type {?} */ (b))));
            }
            return from(stripe.handleCardPayment((/** @type {?} */ (a)), (/** @type {?} */ (b)), (/** @type {?} */ (c))));
        }));
    };
    /**
     * @param {?} a
     * @return {?}
     */
    StripeInstance.prototype.handleCardAction = /**
     * @param {?} a
     * @return {?}
     */
    function (a) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            return from(stripe.handleCardAction((/** @type {?} */ (a))));
        }));
    };
    /**
     * @param {?} a
     * @param {?=} b
     * @return {?}
     */
    StripeInstance.prototype.confirmPaymentIntent = /**
     * @param {?} a
     * @param {?=} b
     * @return {?}
     */
    function (a, b) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            return from(stripe.confirmPaymentIntent((/** @type {?} */ (a)), (/** @type {?} */ (b))));
        }));
    };
    /**
     * @param {?} a
     * @param {?} b
     * @param {?=} c
     * @return {?}
     */
    StripeInstance.prototype.createPaymentMethod = /**
     * @param {?} a
     * @param {?} b
     * @param {?=} c
     * @return {?}
     */
    function (a, b, c) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            /** @type {?} */
            var stripe = (/** @type {?} */ (s));
            return from(stripe.createPaymentMethod(a, b, c));
        }), first());
    };
    return StripeInstance;
}());
export { StripeInstance };
if (false) {
    /**
     * @type {?}
     * @private
     */
    StripeInstance.prototype.stripe$;
    /** @type {?} */
    StripeInstance.prototype.loader;
    /** @type {?} */
    StripeInstance.prototype.window;
    /** @type {?} */
    StripeInstance.prototype.key;
    /** @type {?} */
    StripeInstance.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLWluc3RhbmNlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zdHJpcGUtaW5zdGFuY2UuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVEvRCxPQUFPLEVBR0wsWUFBWSxFQUViLE1BQU0sdUJBQXVCLENBQUM7QUFDL0IsT0FBTyxFQVNMLFNBQVMsRUFDVCxhQUFhLEVBQ2IsYUFBYSxFQUNiLGlCQUFpQixFQUNqQixLQUFLLEVBQ0wsU0FBUyxFQUNWLE1BQU0scUJBQXFCLENBQUM7QUFHN0IsT0FBTyxFQU1MLDBCQUEwQixFQUMzQixNQUFNLDhCQUE4QixDQUFDO0FBRXRDO0lBS0Usd0JBQ1MsTUFBMkIsRUFDM0IsTUFBaUIsRUFDakIsR0FBVyxFQUNYLE9BQWlCO1FBSjFCLGlCQW9CQztRQW5CUSxXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDWCxZQUFPLEdBQVAsT0FBTyxDQUFVO1FBUmxCLFlBQU8sR0FBMEMsSUFBSSxlQUFlLENBRTFFLFNBQVMsQ0FBQyxDQUFDO1FBUVgsSUFBSSxDQUFDLE1BQU07YUFDUixRQUFRLEVBQUU7YUFDVixJQUFJLENBQ0gsTUFBTSxDQUFDLFVBQUMsTUFBYyxJQUFLLE9BQUEsTUFBTSxDQUFDLE1BQU0sS0FBSyxJQUFJLEVBQXRCLENBQXNCLENBQUMsRUFDbEQsS0FBSyxFQUFFLEVBQ1AsR0FBRyxDQUFDLGNBQU0sT0FBQSxDQUFDLG1CQUFBLEtBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEVBQU8sQ0FB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LENBQ1QsTUFBTSxDQUFDLG9CQUFvQixDQUN6QixtQkFBQSxDQUFDLEVBQVUsRUFDWCxtQkFBQSxDQUFDLEVBQTJDLENBQzdDLENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7Ozs7O0lBRU0sNENBQW1COzs7Ozs7SUFBMUIsVUFDRSxDQUFTLEVBQ1QsQ0FBVSxFQUNWLENBQWlDO1FBRWpDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQ3JDLE1BQU0sQ0FBQyxVQUFBLE1BQU0sSUFBSSxPQUFBLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBZixDQUFlLENBQUMsRUFDakMsU0FBUyxDQUFDLFVBQUEsQ0FBQzs7Z0JBQ0gsTUFBTSxHQUFHLG1CQUFBLENBQUMsRUFBWTtZQUU1QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxFQUNGLEtBQUssRUFBRSxDQUNSLENBQUM7SUFDSixDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBOUtELElBOEtDOzs7Ozs7O0lBN0tDLGlDQUVhOztJQUdYLGdDQUFrQzs7SUFDbEMsZ0NBQXdCOztJQUN4Qiw2QkFBa0I7O0lBQ2xCLGlDQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBmaXJzdCwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFdpbmRvd1JlZiB9IGZyb20gJy4vd2luZG93LXJlZi5zZXJ2aWNlJztcbmltcG9ydCB7IExhenlTdHJpcGVBUElMb2FkZXIsIFN0YXR1cyB9IGZyb20gJy4vYXBpLWxvYWRlci5zZXJ2aWNlJztcblxuaW1wb3J0IHsgU3RyaXBlSlMsIE9wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0cmlwZSc7XG5pbXBvcnQgeyBFbGVtZW50IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50JztcbmltcG9ydCB7IEVsZW1lbnRzLCBFbGVtZW50c09wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2VsZW1lbnRzJztcbmltcG9ydCB7XG4gIFNvdXJjZURhdGEsXG4gIFNvdXJjZVJlc3VsdCxcbiAgaXNTb3VyY2VEYXRhLFxuICBTb3VyY2VQYXJhbXNcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zb3VyY2VzJztcbmltcG9ydCB7XG4gIENhcmREYXRhT3B0aW9ucyxcbiAgVG9rZW5SZXN1bHQsXG4gIEFjY291bnQsXG4gIEFjY291bnREYXRhLFxuICBCYW5rQWNjb3VudCxcbiAgQmFua0FjY291bnREYXRhLFxuICBQaWlEYXRhLFxuICBQaWksXG4gIGlzQWNjb3VudCxcbiAgaXNBY2NvdW50RGF0YSxcbiAgaXNCYW5rQWNjb3VudCxcbiAgaXNCYW5rQWNjb3VudERhdGEsXG4gIGlzUGlpLFxuICBpc1BpaURhdGFcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy90b2tlbic7XG5pbXBvcnQgeyBTdHJpcGVTZXJ2aWNlSW50ZXJmYWNlIH0gZnJvbSAnLi9zdHJpcGUtaW5zdGFuY2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBheW1lbnRSZXF1ZXN0T3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvcGF5bWVudC1yZXF1ZXN0JztcbmltcG9ydCB7XG4gIEhhbmRsZUNhcmRQYXltZW50T3B0aW9ucyxcbiAgUGF5bWVudEludGVudFJlc3VsdCxcbiAgQ29uZmlybVBheW1lbnRJbnRlbnRPcHRpb25zLFxuICBQYXltZW50TWV0aG9kRGF0YSxcbiAgUGF5bWVudE1ldGhvZFJlc3VsdCxcbiAgaXNIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnNcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9wYXltZW50LWludGVudCc7XG5cbmV4cG9ydCBjbGFzcyBTdHJpcGVJbnN0YW5jZSBpbXBsZW1lbnRzIFN0cmlwZVNlcnZpY2VJbnRlcmZhY2Uge1xuICBwcml2YXRlIHN0cmlwZSQ6IEJlaGF2aW9yU3ViamVjdDxTdHJpcGVKUyB8IHVuZGVmaW5lZD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFxuICAgIFN0cmlwZUpTIHwgdW5kZWZpbmVkXG4gID4odW5kZWZpbmVkKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgbG9hZGVyOiBMYXp5U3RyaXBlQVBJTG9hZGVyLFxuICAgIHB1YmxpYyB3aW5kb3c6IFdpbmRvd1JlZixcbiAgICBwdWJsaWMga2V5OiBzdHJpbmcsXG4gICAgcHVibGljIG9wdGlvbnM/OiBPcHRpb25zXG4gICkge1xuICAgIHRoaXMubG9hZGVyXG4gICAgICAuYXNTdHJlYW0oKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoc3RhdHVzOiBTdGF0dXMpID0+IHN0YXR1cy5sb2FkZWQgPT09IHRydWUpLFxuICAgICAgICBmaXJzdCgpLFxuICAgICAgICBtYXAoKCkgPT4gKHRoaXMud2luZG93LmdldE5hdGl2ZVdpbmRvdygpIGFzIGFueSkuU3RyaXBlKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoU3RyaXBlOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gdGhpcy5vcHRpb25zXG4gICAgICAgICAgPyAoU3RyaXBlKHRoaXMua2V5LCB0aGlzLm9wdGlvbnMpIGFzIFN0cmlwZUpTKVxuICAgICAgICAgIDogKFN0cmlwZSh0aGlzLmtleSkgYXMgU3RyaXBlSlMpO1xuXG4gICAgICAgIHRoaXMuc3RyaXBlJC5uZXh0KHN0cmlwZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRJbnN0YW5jZSgpOiBTdHJpcGVKUyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgcHVibGljIGVsZW1lbnRzKG9wdGlvbnM/OiBFbGVtZW50c09wdGlvbnMpOiBPYnNlcnZhYmxlPEVsZW1lbnRzPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgbWFwKHN0cmlwZSA9PiAoc3RyaXBlIGFzIFN0cmlwZUpTKS5lbGVtZW50cyhvcHRpb25zKSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUb2tlbihcbiAgICBhOiBFbGVtZW50IHwgQWNjb3VudCB8IEJhbmtBY2NvdW50IHwgUGlpLFxuICAgIGI6IENhcmREYXRhT3B0aW9ucyB8IEFjY291bnREYXRhIHwgQmFua0FjY291bnREYXRhIHwgUGlpRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFRva2VuUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgc3dpdGNoTWFwKHMgPT4ge1xuICAgICAgICBjb25zdCBzdHJpcGUgPSBzIGFzIFN0cmlwZUpTO1xuXG4gICAgICAgIGlmIChpc0FjY291bnQoYSkgJiYgaXNBY2NvdW50RGF0YShiKSkge1xuICAgICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNCYW5rQWNjb3VudChhKSAmJiBpc0JhbmtBY2NvdW50RGF0YShiKSkge1xuICAgICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNQaWkoYSkgJiYgaXNQaWlEYXRhKGIpKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHN0cmlwZS5jcmVhdGVUb2tlbihhIGFzIEVsZW1lbnQsIGIgYXMgQ2FyZERhdGFPcHRpb25zIHwgdW5kZWZpbmVkKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgZmlyc3QoKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlU291cmNlKFxuICAgIGE6IEVsZW1lbnQgfCBTb3VyY2VEYXRhLFxuICAgIGI/OiBTb3VyY2VEYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U291cmNlUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgc3dpdGNoTWFwKHMgPT4ge1xuICAgICAgICBjb25zdCBzdHJpcGUgPSBzIGFzIFN0cmlwZUpTO1xuXG4gICAgICAgIGlmIChpc1NvdXJjZURhdGEoYSkpIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShzdHJpcGUuY3JlYXRlU291cmNlKGEgYXMgU291cmNlRGF0YSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBFbGVtZW50LCBiKSk7XG4gICAgICB9KSxcbiAgICAgIGZpcnN0KClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHJldHJpZXZlU291cmNlKHNvdXJjZTogU291cmNlUGFyYW1zKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLnJldHJpZXZlU291cmNlKHNvdXJjZSkpO1xuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBwYXltZW50UmVxdWVzdChvcHRpb25zOiBQYXltZW50UmVxdWVzdE9wdGlvbnMpIHtcbiAgICBjb25zdCBzdHJpcGUgPSB0aGlzLmdldEluc3RhbmNlKCk7XG4gICAgaWYgKHN0cmlwZSkge1xuICAgICAgcmV0dXJuIHN0cmlwZS5wYXltZW50UmVxdWVzdChvcHRpb25zKTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkUGF5bWVudChcbiAgICBhOiBzdHJpbmcsXG4gICAgYjogRWxlbWVudCB8IEhhbmRsZUNhcmRQYXltZW50T3B0aW9ucyxcbiAgICBjPzogSGFuZGxlQ2FyZFBheW1lbnRPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGZpbHRlcihzdHJpcGUgPT4gQm9vbGVhbihzdHJpcGUpKSxcbiAgICAgIHN3aXRjaE1hcChzID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gcyBhcyBTdHJpcGVKUztcblxuICAgICAgICBpZiAoaXNIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMoYikpIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHN0cmlwZS5oYW5kbGVDYXJkUGF5bWVudChhIGFzIHN0cmluZywgYiBhcyBIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMpXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgIHN0cmlwZS5oYW5kbGVDYXJkUGF5bWVudChcbiAgICAgICAgICAgIGEgYXMgc3RyaW5nLFxuICAgICAgICAgICAgYiBhcyBFbGVtZW50LFxuICAgICAgICAgICAgYyBhcyBIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlQ2FyZEFjdGlvbihhOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmhhbmRsZUNhcmRBY3Rpb24oYSBhcyBzdHJpbmcpKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjb25maXJtUGF5bWVudEludGVudChcbiAgICBhOiBzdHJpbmcsXG4gICAgYj86IENvbmZpcm1QYXltZW50SW50ZW50T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgc3RyaXBlLmNvbmZpcm1QYXltZW50SW50ZW50KFxuICAgICAgICAgICAgYSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBiIGFzIENvbmZpcm1QYXltZW50SW50ZW50T3B0aW9ucyB8IHVuZGVmaW5lZFxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVQYXltZW50TWV0aG9kKFxuICAgIGE6IHN0cmluZyxcbiAgICBiOiBFbGVtZW50LFxuICAgIGM/OiBQYXltZW50TWV0aG9kRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFBheW1lbnRNZXRob2RSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVBheW1lbnRNZXRob2QoYSwgYiwgYykpO1xuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxufVxuIl19